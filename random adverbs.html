<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hebrew Quiz & Manager</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
}

.container {
    max-width: 1000px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

.section {
    margin-bottom: 25px;
}

label {
    font-weight: bold;
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

input[type=range] {
    flex: 1;
}

button {
    padding: 8px 14px;
    margin: 4px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #4a7cff;
    color: white;
}

button:hover {
    background: #345dd1;
}

button.secondary {
    background: #888;
}

button.success {
    background: #28a745;
}

button.danger {
    background: #dc3545;
}

.answers {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.answer-btn {
    padding: 12px;
    font-size: 14px;
}

#word {
    font-size: 36px;
    font-weight: bold;
    text-align: center;
    margin: 15px 0;
}

#details {
    border: 1px solid #ddd;
    padding: 10px;
    height: 200px;
    overflow-y: auto;
    background: #fafafa;
    white-space: pre-wrap;
}

.footer-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.hidden {
    display: none;
}
</style>
</head>

<body>
<div class="container">
<h1>Hebrew Quiz & Manager</h1>

<div class="section">
<label>Source:</label>
<label><input type="radio" name="source" value="jsonl" checked> Full Dictionary</label>
<label><input type="radio" name="source" value="custom"> My Custom List</label>
</div>

<div class="section">
<div class="slider-container">
<label>Min Pop:</label>
<input type="range" id="minSlider" min="0" max="100" value="0">
<span id="minVal">0</span>
</div>

<div class="slider-container">
<label>Max Pop:</label>
<input type="range" id="maxSlider" min="0" max="100" value="100">
<span id="maxVal">0</span>
</div>

<div><strong id="foundCount">Words found: 0</strong></div>
</div>

<div class="section">
<label>Seed:</label>
<input type="number" id="seed" value="1">
<label>Total Words:</label>
<input type="number" id="totalWords" value="10">
<button onclick="startQuiz()">Start / Restart Quiz</button>
</div>

<hr>

<div class="section">
<div id="progress"></div>
<div id="word">Press Start</div>

<div class="answers" id="answers"></div>

<div class="footer-controls">
<div>
<label><input type="checkbox" id="autoNext"> Auto-next</label>
</div>

<div>
<button onclick="skipQuestion()">Skip</button>
<button onclick="nextQuestion()">Next</button>
<button onclick="addToCustom()">+ Add to Custom</button>
</div>
</div>
</div>

<div class="section">
<h3>Word Details</h3>
<div id="details">(Answer or Skip to see details...)</div>
</div>

<div class="section">
<h3>Custom List</h3>
<button onclick="downloadCustom()">Download CSV</button>
<input type="file" id="csvLoader" accept=".csv">
</div>

</div>

<script>
let fullDB = [];
let popMap = {};
let customDB = [];

let currentQuiz = [];
let currentIndex = -1;
let currentQuestion = null;

let maxFreqLimit = 1;

// --- Helpers ---

function removeNikkud(text) {
    return text.normalize("NFKD").replace(/[\u0591-\u05C7]/g, "");
}

function logScale(sliderVal) {
    if (sliderVal <= 0) return 0;
    const minLog = Math.log(1);
    const maxLog = Math.log(maxFreqLimit);
    return Math.floor(Math.exp(minLog + (sliderVal/100)*(maxLog-minLog)));
}

function shuffle(array, seed) {
    let rng = mulberry32(seed);
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function mulberry32(a) {
    return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}

// --- Loading Data ---

async function loadPopularity() {
    const res = await fetch("words by popularity.csv");
    const text = await res.text();
    const lines = text.split("\n");

    lines.forEach(line => {
        const parts = line.split(",");
        if (parts.length >= 2) {
            const word = removeNikkud(parts[0].trim());
            const count = parseInt(parts[1]);
            if (!isNaN(count)) popMap[word] = count;
        }
    });
}

async function loadJSONL() {
    const res = await fetch("he_adv.jsonl");
    const text = await res.text();
    const lines = text.split("\n");

    lines.forEach(line => {
        if (!line.trim()) return;
        const data = JSON.parse(line);

        const wordOrig = data.word || "";
        const wordClean = removeNikkud(wordOrig);

        let translit = "N/A";
        if (data.head_templates && data.head_templates.length) {
            translit = data.head_templates[0].args?.tr || "N/A";
        }

        let definition = "Unknown";
        let examples = [];
        if (data.senses && data.senses.length) {
            definition = data.senses[0].glosses?.[0] || "Unknown";
            (data.senses[0].examples || []).forEach(ex => {
                examples.push([ex.text || "", ex.translation || ""]);
            });
        }

        fullDB.push({
            word: wordOrig,
            clean: wordClean,
            transliteration: translit,
            definition,
            etymology: data.etymology_text || "N/A",
            forms: "",
            examples,
            frequency: popMap[wordClean] || 0
        });
    });

    maxFreqLimit = Math.max(...fullDB.map(w => w.frequency));
}

// --- UI Updates ---

function updateCounts() {
    const minF = logScale(minSlider.value);
    const maxF = logScale(maxSlider.value);

    minVal.textContent = minF;
    maxVal.textContent = maxF;

    const count = fullDB.filter(w => w.frequency >= minF && w.frequency <= maxF).length;
    foundCount.textContent = "Words found: " + count;
}

minSlider.oninput = updateCounts;
maxSlider.oninput = updateCounts;

// --- Quiz Logic ---

function startQuiz() {
    const source = document.querySelector('input[name="source"]:checked').value;

    let pool = [];

    if (source === "jsonl") {
        const minF = logScale(minSlider.value);
        const maxF = logScale(maxSlider.value);
        pool = fullDB.filter(w => w.frequency >= minF && w.frequency <= maxF);
    } else {
        pool = customDB;
    }

    if (!pool.length) {
        alert("No words found.");
        return;
    }

    shuffle(pool, parseInt(seed.value));

    currentQuiz = pool.slice(0, parseInt(totalWords.value));
    currentIndex = -1;

    nextQuestion();
}

function nextQuestion() {
    currentIndex++;
    if (currentIndex >= currentQuiz.length) {
        shuffle(currentQuiz, Date.now());
        currentIndex = 0;
    }

    currentQuestion = currentQuiz[currentIndex];

    progress.textContent = `Question ${currentIndex+1}/${currentQuiz.length}`;
    word.textContent = currentQuestion.word;

    details.textContent = "(Answer or Skip to see details...)";

    generateAnswers();
}

function generateAnswers() {
    const correct = currentQuestion.definition;
    const distractors = [];

    while (distractors.length < 3) {
        const w = fullDB[Math.floor(Math.random()*fullDB.length)];
        if (w.definition !== correct && !distractors.includes(w.definition)) {
            distractors.push(w.definition);
        }
    }

    const options = [...distractors, correct].sort(() => Math.random()-0.5);

    answers.innerHTML = "";
    options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "answer-btn";
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(btn, opt === correct);
        answers.appendChild(btn);
    });
}

function checkAnswer(button, correct) {
    if (correct) {
        button.style.background = "#28a745";
    } else {
        button.style.background = "#dc3545";
    }
    revealAnswer();
}

function skipQuestion() {
    revealAnswer();
}

function revealAnswer() {
    document.querySelectorAll(".answer-btn").forEach(btn => btn.disabled = true);

    let text = "";
    text += "Transliteration: " + currentQuestion.transliteration + "\n\n";
    text += "Definition: " + currentQuestion.definition + "\n\n";
    text += "Etymology: " + currentQuestion.etymology + "\n\n";
    text += "Examples:\n";
    currentQuestion.examples.forEach((ex,i)=>{
        text += `${i+1}. ${ex[0]} â€” ${ex[1]}\n`;
    });

    details.textContent = text;

    if (autoNext.checked) {
        setTimeout(nextQuestion, 1500);
    }
}

// --- Custom CSV ---

function addToCustom() {
    customDB.push(currentQuestion);
    alert("Added to custom list.");
}

function downloadCustom() {
    let csv = "Word,Transliteration,Definition,Etymology,Forms,Examples\n";
    customDB.forEach(w=>{
        const exStr = w.examples.map(e=>`${e[0]} (${e[1]})`).join(" | ");
        csv += `"${w.word}","${w.transliteration}","${w.definition}","${w.etymology}","${w.forms}","${exStr}"\n`;
    });

    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "saved_words.csv";
    a.click();
}

csvLoader.addEventListener("change", function() {
    const file = this.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const lines = e.target.result.split("\n").slice(1);
        customDB = [];

        lines.forEach(line=>{
            if (!line.trim()) return;
            const parts = line.split('","').map(s=>s.replace(/(^"|"$)/g,''));
            if (parts.length >= 6) {
                customDB.push({
                    word: parts[0],
                    transliteration: parts[1],
                    definition: parts[2],
                    etymology: parts[3],
                    forms: parts[4],
                    examples: [],
                    frequency: 0
                });
            }
        });

        alert("Custom list loaded.");
    };

    reader.readAsText(file);
});

// --- Init ---

(async function init(){
    await loadPopularity();
    await loadJSONL();
    updateCounts();
})();
</script>
</body>
</html>
