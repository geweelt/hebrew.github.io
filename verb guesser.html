<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hebrew Verb Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;700&display=swap');
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hebrew-text { direction: rtl; }
        .hidden { display: none; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f3f4f6; }
        /* Simple spinner for loading state */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">Hebrew Verb Quiz</h1>

        <div id="loading-overlay" class="flex flex-col items-center justify-center p-10">
            <div class="loader mb-4"></div>
            <p class="text-gray-600">Fetching data files from server...</p>
        </div>

        <div id="main-interface" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="space-y-6">
                    <section>
                        <h3 class="font-bold border-b mb-2 text-gray-800">Quiz Mode</h3>
                        <div class="space-y-1">
                            <label class="flex items-center"><input type="radio" name="mode" value="he-en" checked class="mr-2"> Hebrew → English</label>
                            <label class="flex items-center"><input type="radio" name="mode" value="en-he" class="mr-2"> English → Hebrew</label>
                        </div>
                    </section>

                    <section>
                        <h3 class="font-bold border-b mb-2 text-gray-800">Allowed Forms (He→En)</h3>
                        <div id="form-vars" class="grid grid-cols-2 gap-1">
                            <label class="text-sm"><input type="checkbox" value="infinitive" checked> infinitive</label>
                            <label class="text-sm"><input type="checkbox" value="past"> past</label>
                            <label class="text-sm"><input type="checkbox" value="present"> present</label>
                            <label class="text-sm"><input type="checkbox" value="future"> future</label>
                            <label class="text-sm"><input type="checkbox" value="imperative"> imperative</label>
                            <label class="text-sm"><input type="checkbox" value="participle"> participle</label>
                        </div>
                    </section>

                    <section>
                        <h3 class="font-bold border-b mb-2 text-gray-800">Popularity (Log Scale)</h3>
                        <div class="bg-blue-50 p-3 rounded">
                            <label class="block text-xs font-semibold">Min: <span id="min-val">0</span></label>
                            <input type="range" id="min-slider" min="0" max="7" step="0.1" value="0" class="w-full">
                            <label class="block text-xs font-semibold mt-2">Max: <span id="max-val">7</span></label>
                            <input type="range" id="max-slider" min="0" max="7" step="0.1" value="7" class="w-full">
                            <p id="stats-label" class="text-xs text-blue-700 mt-2 font-bold">0 verbs match filter</p>
                        </div>
                    </section>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="text-center p-8 bg-gray-50 rounded-lg border-2 border-gray-100 min-h-[300px] flex flex-col justify-center">
                        <div id="question-text" class="text-3xl font-bold mb-8">Loading...</div>
                        <div id="answer-grid" class="grid grid-cols-1 gap-3"></div>
                    </div>

                    <div class="flex flex-wrap justify-center gap-4">
                        <label class="flex items-center text-sm font-medium"><input type="checkbox" id="auto-next" class="mr-2"> Auto Next</label>
                        <button onclick="showCorrect()" class="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 font-semibold transition">Show Correct</button>
                        <button onclick="nextQuestion()" class="px-8 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition">Next</button>
                    </div>

                    <div id="conjugation-section" class="hidden border-t-2 border-gray-100 pt-6">
                        <div class="bg-blue-900 text-white rounded-t-lg py-2 px-4 flex justify-between items-center">
                            <h2 id="root-display" class="font-bold"></h2>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs uppercase">Zoom</span>
                                <input type="range" id="zoom-slider" min="14" max="32" value="18" class="w-24 accent-blue-400">
                            </div>
                        </div>
                        <div id="tables-container" class="bg-white border p-4 space-y-8 overflow-x-auto rounded-b-lg"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const JSONL_URL = 'he_verbs.jsonl';
        const CSV_URL = 'words by popularity.csv';

        // --- State ---
        let allEntries = [];
        let popularityMap = {};
        let filteredEntries = [];
        let currentEntry = null;
        let currentCorrect = "";
        let isLocked = false;

        // --- Initialization ---
        window.onload = init;

        async function init() {
            try {
                const [jsonlRes, csvRes] = await Promise.all([
                    fetch(JSONL_URL),
                    fetch(CSV_URL)
                ]);

                if (!jsonlRes.ok || !csvRes.ok) throw new Error("Could not find data files on server.");

                // Process CSV
                const csvText = await csvRes.text();
                csvText.split(/\r?\n/).forEach(line => {
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const word = parts[0].replace(/^"|"$/g, '').trim();
                        const freq = parseInt(parts[1]);
                        if (!isNaN(freq)) popularityMap[word] = freq;
                    }
                });

                // Process JSONL
                const jsonlText = await jsonlRes.text();
                allEntries = jsonlText.split('\n')
                    .filter(line => line.trim())
                    .map(line => {
                        try { return JSON.parse(line); } 
                        catch(e) { return null; }
                    })
                    .filter(e => e && e.pos === 'verb');

                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('main-interface').classList.remove('hidden');
                
                applyFilter();
                nextQuestion();
            } catch (err) {
                document.getElementById('loading-overlay').innerHTML = 
                    `<p class="text-red-600 font-bold">Error: ${err.message}</p>
                     <p class="text-sm text-gray-500 mt-2">Ensure files are in the same folder as this HTML file.</p>`;
            }
        }

        // --- Core Helpers ---
        const getInfinitive = (entry) => {
            const forms = entry.forms || [];
            let inf = forms.find(f => (f.tags || []).includes("infinitive"));
            if (inf) return inf.form;
            inf = forms.find(f => f.form.startsWith("ל"));
            return inf ? inf.form : null;
        };

        const getRoot = (entry) => {
            const templates = entry.etymology_templates || [];
            const rootBox = templates.find(t => t.name === "he-rootbox");
            return rootBox ? rootBox.args["1"] : "Unknown";
        };

        const getGloss = (entry) => {
            return entry.senses?.[0]?.glosses?.[0] || entry.senses?.[0]?.definitions?.[0] || "Unknown";
        };

        // --- Logic ---
        function applyFilter() {
            const minLog = parseFloat(document.getElementById('min-slider').value);
            const maxLog = parseFloat(document.getElementById('max-slider').value);
            const minVal = Math.pow(10, minLog);
            const maxVal = Math.pow(10, maxLog);

            document.getElementById('min-val').innerText = Math.floor(minVal).toLocaleString();
            document.getElementById('max-val').innerText = Math.floor(maxVal).toLocaleString();

            filteredEntries = allEntries.filter(e => {
                const inf = getInfinitive(e);
                const count = popularityMap[inf] || 0;
                return count >= minVal && count <= maxVal;
            });

            document.getElementById('stats-label').innerText = `${filteredEntries.length} verbs match filter`;
        }

        document.getElementById('min-slider').oninput = applyFilter;
        document.getElementById('max-slider').oninput = applyFilter;

        function nextQuestion() {
            if (filteredEntries.length === 0) {
                alert("No verbs match this popularity range.");
                return;
            }
            
            isLocked = false;
            currentEntry = filteredEntries[Math.floor(Math.random() * filteredEntries.length)];
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const root = getRoot(currentEntry);

            document.getElementById('conjugation-section').classList.add('hidden');
            
            if (mode === "he-en") {
                const allowedTags = Array.from(document.querySelectorAll('#form-vars input:checked')).map(i => i.value);
                let forms = (currentEntry.forms || [])
                    .filter(f => f.tags.some(t => allowedTags.includes(t)))
                    .map(f => f.form);
                
                if (forms.length === 0) forms = [getInfinitive(currentEntry)];
                
                const question = forms[Math.floor(Math.random() * forms.length)];
                currentCorrect = getGloss(currentEntry);
                displayQuestion(question, buildVariants(currentCorrect, 'en'), "hebrew-text");
            } else {
                const question = getGloss(currentEntry);
                currentCorrect = getInfinitive(currentEntry);
                displayQuestion(question, buildVariants(currentCorrect, 'he'), "hebrew-text");
            }
        }

        function buildVariants(correct, type) {
            let pool = (type === 'en') 
                ? allEntries.map(e => getGloss(e)) 
                : allEntries.map(e => getInfinitive(e));
            
            pool = [...new Set(pool.filter(v => v && v !== correct))];
            const selected = pool.sort(() => 0.5 - Math.random()).slice(0, 3);
            selected.push(correct);
            return selected.sort(() => 0.5 - Math.random());
        }

        function displayQuestion(q, variants, cls) {
            const qEl = document.getElementById('question-text');
            qEl.innerText = q;
            qEl.className = `text-3xl font-bold mb-8 ${cls}`;

            const grid = document.getElementById('answer-grid');
            grid.innerHTML = '';
            variants.forEach(v => {
                const btn = document.createElement('button');
                btn.className = "p-4 border-2 rounded-xl hover:border-blue-400 hover:bg-blue-50 transition-all text-lg font-medium bg-white";
                btn.innerText = v;
                btn.onclick = () => checkAnswer(v, btn);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(selected, btn) {
            if (isLocked) return;
            if (selected === currentCorrect) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                showTables();
                isLocked = true;
                if (document.getElementById('auto-next').checked) setTimeout(nextQuestion, 1800);
            } else {
                btn.classList.add('bg-red-50', 'text-red-300', 'border-red-100');
            }
        }

        function showCorrect() {
            showTables();
            isLocked = true;
            const buttons = document.querySelectorAll('#answer-grid button');
            buttons.forEach(b => {
                if(b.innerText === currentCorrect) b.classList.add('bg-green-100', 'border-green-500');
            });
        }

        function showTables() {
            const container = document.getElementById('tables-container');
            const section = document.getElementById('conjugation-section');
            container.innerHTML = '';
            section.classList.remove('hidden');
            
            document.getElementById('root-display').innerText = `Root: ${getRoot(currentEntry)}`;
            
            const tenses = { "Past": {}, "Present": {}, "Future": {}, "Imperative": {} };
            (currentEntry.forms || []).forEach(f => {
                const t = f.tags || [];
                let tense = t.includes("past") ? "Past" : t.includes("present") ? "Present" : t.includes("future") ? "Future" : t.includes("imperative") ? "Imperative" : null;
                if (!tense) return;
                
                const person = t.includes("first-person") ? "1" : t.includes("second-person") ? "2" : "3";
                const number = t.includes("singular") ? "S" : "P";
                const gender = t.includes("masculine") ? "M" : t.includes("feminine") ? "F" : "";
                tenses[tense][`${person}${number}${gender}`] = f.form;
            });

            Object.entries(tenses).forEach(([name, data]) => {
                if (Object.keys(data).length === 0) return;
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<h4 class="font-bold text-gray-500 text-sm uppercase mb-2 tracking-widest">${name}</h4>`;
                
                let html = '<table>';
                if (name === "Past" || name === "Future") {
                    html += `<tr><th>I</th><td class="hebrew-text font-bold">${data['1SM'] || ''}</td><th>We</th><td class="hebrew-text font-bold">${data['1PM'] || ''}</td></tr>
                             <tr><th>You (m)</th><td class="hebrew-text font-bold">${data['2SM'] || ''}</td><th>You (m.p)</th><td class="hebrew-text font-bold">${data['2PM'] || ''}</td></tr>
                             <tr><th>You (f)</th><td class="hebrew-text font-bold">${data['2SF'] || ''}</td><th>You (f.p)</th><td class="hebrew-text font-bold">${data['2PF'] || ''}</td></tr>
                             <tr><th>He</th><td class="hebrew-text font-bold">${data['3SM'] || ''}</td><th>They (m)</th><td class="hebrew-text font-bold">${data['3PM'] || ''}</td></tr>
                             <tr><th>She</th><td class="hebrew-text font-bold">${data['3SF'] || ''}</td><th>They (f)</th><td class="hebrew-text font-bold">${data['3PF'] || ''}</td></tr>`;
                } else {
                    html += `<tr><th>M Sing.</th><th>F Sing.</th><th>M Plur.</th><th>F Plur.</th></tr>
                             <tr>
                                <td class="hebrew-text font-bold">${data['1SM'] || data['2SM'] || data['3SM'] || ''}</td>
                                <td class="hebrew-text">${data['1SF'] || data['2SF'] || data['3SF'] || ''}</td>
                                <td class="hebrew-text font-bold">${data['1PM'] || data['2PM'] || data['3PM'] || ''}</td>
                                <td class="hebrew-text">${data['1PF'] || data['2PF'] || data['3PF'] || ''}</td>
                             </tr>`;
                }
                html += '</table>';
                wrapper.innerHTML += html;
                container.appendChild(wrapper);
            });
            updateZoom();
        }

        function updateZoom() {
            const size = document.getElementById('zoom-slider').value;
            document.querySelectorAll('.hebrew-text').forEach(el => {
                el.style.fontSize = size + 'px';
            });
        }
        document.getElementById('zoom-slider').oninput = updateZoom;
    </script>
</body>
</html>